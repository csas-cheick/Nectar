{% extends "base.html" %}

{% block title %}Mon Historique - Nectar{% endblock %}

{% block nav_history %}active{% endblock %}

{% block head %}
<style>
    .page-content { max-width: 1400px; margin: 0 auto; padding: 40px 32px; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
    .page-title h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
    .page-title h1 svg { width: 32px; height: 32px; color: var(--primary); }
    .page-title p { color: var(--text-dim); font-size: 1rem; }
    .header-actions { display: flex; gap: 12px; }
    .btn-danger { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #f87171; }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 16px; }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .stat-icon svg { width: 24px; height: 24px; }
    .stat-icon.purple { background: rgba(124, 58, 237, 0.15); color: #a855f7; }
    .stat-icon.green { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .stat-icon.orange { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .stat-content h3 { font-size: 1.5rem; font-weight: 700; }
    .stat-content p { color: var(--text-dim); font-size: 0.85rem; }

    .filters-bar { display: flex; gap: 16px; margin-bottom: 32px; }
    .search-box { flex: 1; position: relative; }
    .search-box svg { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: var(--text-dim); }
    .search-box input { width: 100%; padding: 14px 16px 14px 48px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 0.95rem; font-family: inherit; }
    .search-box input:focus { outline: none; border-color: var(--primary); }
    .search-box input::placeholder { color: var(--text-dim); }
    .filter-select { padding: 14px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 0.95rem; cursor: pointer; font-family: inherit; }
    .filter-select:focus { outline: none; border-color: var(--primary); }

    .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 24px; }
    .history-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: all 0.3s; }
    .history-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .card-title { display: flex; align-items: center; gap: 12px; }
    .card-icon { width: 40px; height: 40px; background: rgba(124, 58, 237, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--primary); }
    .card-icon svg { width: 20px; height: 20px; }
    .card-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-info span { font-size: 0.8rem; color: var(--text-dim); }
    .card-badge { padding: 6px 12px; background: rgba(124, 58, 237, 0.15); color: var(--primary); border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .card-preview { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin-bottom: 20px; display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .card-stats { display: flex; gap: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
    .card-stat { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted); }
    .card-stat svg { width: 14px; height: 14px; color: var(--text-dim); }
    .card-stat strong { color: var(--text); }
    .card-actions { display: flex; gap: 8px; margin-top: 16px; }
    .card-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.3s; font-family: inherit; }
    .card-btn svg { width: 16px; height: 16px; }
    .card-btn.view { background: rgba(124, 58, 237, 0.15); color: #a855f7; }
    .card-btn.view:hover { background: rgba(124, 58, 237, 0.25); }
    .card-btn.copy { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .card-btn.copy:hover { background: rgba(34, 197, 94, 0.25); }
    .card-btn.delete { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .card-btn.delete:hover { background: rgba(239, 68, 68, 0.25); }

    .empty-state { grid-column: 1 / -1; text-align: center; padding: 80px 20px; }
    .empty-icon { width: 80px; height: 80px; background: rgba(124, 58, 237, 0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
    .empty-icon svg { width: 40px; height: 40px; color: var(--text-dim); }
    .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; }
    .empty-state p { color: var(--text-dim); margin-bottom: 24px; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 20px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid var(--border); }
    .modal-header h2 { font-size: 1.25rem; display: flex; align-items: center; gap: 12px; }
    .modal-header h2 svg { width: 24px; height: 24px; color: var(--primary); }
    .modal-close { width: 40px; height: 40px; background: rgba(239, 68, 68, 0.1); border: none; border-radius: 10px; color: #f87171; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: rgba(239, 68, 68, 0.2); }
    .modal-close svg { width: 20px; height: 20px; }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-content-text { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; line-height: 1.8; white-space: pre-wrap; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid var(--border); }

    .history-loading { display: flex; justify-content: center; padding: 60px; grid-column: 1 / -1; }

    .login-required { text-align: center; padding: 120px 20px; }
    .login-required .empty-icon { width: 100px; height: 100px; }
    .login-required .empty-icon svg { width: 50px; height: 50px; }
    .login-required h3 { font-size: 1.5rem; margin-bottom: 12px; }
    .login-required p { max-width: 400px; margin: 0 auto 32px; color: var(--text-dim); }

    @media (max-width: 1024px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .page-content { padding: 24px 16px; } .page-header { flex-direction: column; gap: 20px; } .history-grid { grid-template-columns: 1fr; } .filters-bar { flex-direction: column; } .stats-row { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<!-- Si non connecté -->
<main class="page-content hidden" id="loginRequiredContent">
    <div class="login-required">
        <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        </div>
        <h3>Accédez à votre historique</h3>
        <p>Connectez-vous pour retrouver tous vos résumés et documents traités</p>
        <a href="/login" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            Se connecter
        </a>
    </div>
</main>

<!-- Si connecté -->
<main class="page-content" id="loggedInContent">
    <div class="page-header">
        <div class="page-title">
            <h1><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Mon Historique</h1>
            <p>Retrouvez tous vos résumés et documents traités</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="loadHistory()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>Actualiser</button>
            <button class="btn btn-danger" onclick="clearAllHistory()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>Tout effacer</button>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-card"><div class="stat-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><div class="stat-content"><h3 id="totalSummaries">0</h3><p>Résumés générés</p></div></div>
        <div class="stat-card"><div class="stat-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20v-4"></path></svg></div><div class="stat-content"><h3 id="totalWords">0</h3><p>Mots traités</p></div></div>
        <div class="stat-card"><div class="stat-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div><div class="stat-content"><h3 id="avgCompression">0%</h3><p>Compression moyenne</p></div></div>
        <div class="stat-card"><div class="stat-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div><div class="stat-content"><h3 id="timeSaved">0 min</h3><p>Temps économisé</p></div></div>
    </div>

    <div class="filters-bar">
        <div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><input type="text" id="searchInput" placeholder="Rechercher dans l'historique..."></div>
        <select class="filter-select" id="styleFilter" title="Filtrer par style"><option value="">Tous les styles</option><option value="paragraph">Paragraphe</option><option value="bullets">Points clés</option><option value="academic">Académique</option><option value="simple">Simple</option></select>
    </div>

    <div class="history-grid" id="historyGrid"><div class="history-loading"><div class="spinner"></div></div></div>
</main>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
        <div class="modal-header"><h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><span id="modalTitle">Détails</span></h2><button class="modal-close" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
        <div class="modal-body"><div class="modal-content-text" id="modalContent"></div></div>
        <div class="modal-footer"><button class="btn btn-outline" onclick="copyModalContent()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>Copier</button><button class="btn btn-primary" onclick="closeModal()">Fermer</button></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null, historyData = [];

    async function checkAuth() {
        const user = await checkAuthAndUpdateHeader();
        if (user) {
            currentUser = user;
            document.getElementById('loggedInContent').classList.remove('hidden');
            loadHistory();
        } else {
            document.getElementById('loggedInContent').classList.add('hidden');
            document.getElementById('loginRequiredContent').classList.remove('hidden');
        }
    }

    async function loadHistory() {
        try {
            const res = await fetch('/api/history');
            const data = await res.json();
            if (data.success) { historyData = data.history || []; renderHistory(historyData); updateStats(historyData); }
        } catch (e) { console.error(e); document.getElementById('historyGrid').innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><h3>Erreur</h3><p>Impossible de charger</p></div>'; }
    }

    function renderHistory(data) {
        const grid = document.getElementById('historyGrid');
        if (!data || data.length === 0) { grid.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div><h3>Aucun historique</h3><p>Commencez par résumer un document</p><a href="/" class="btn btn-primary" style="display:inline-flex;margin-top:16px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Nouveau résumé</a></div>'; return; }
        grid.innerHTML = data.map(item => `<div class="history-card"><div class="card-header"><div class="card-title"><div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><div class="card-info"><h3>${item.filename||'Sans titre'}</h3><span>${formatDate(item.created_at)}</span></div></div><span class="card-badge">${item.style||'paragraph'}</span></div><p class="card-preview">${item.summary||'Aucun contenu'}</p><div class="card-stats"><div class="card-stat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg><strong>${item.original_words||0}</strong> mots</div><div class="card-stat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg><strong>${item.summary_words||0}</strong> résumé</div><div class="card-stat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg><strong>${item.compression_rate||0}%</strong></div></div><div class="card-actions"><button class="card-btn view" onclick="viewItem('${item.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>Voir</button><button class="card-btn copy" onclick="copyItem('${item.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>Copier</button><button class="card-btn delete" onclick="deleteItem('${item.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>Suppr.</button></div></div>`).join('');
    }

    function updateStats(data) { const t = data.length, w = data.reduce((s,i)=>s+(i.original_words||0),0), c = t>0?Math.round(data.reduce((s,i)=>s+(i.compression_rate||0),0)/t):0; document.getElementById('totalSummaries').textContent=t; document.getElementById('totalWords').textContent=w.toLocaleString(); document.getElementById('avgCompression').textContent=c+'%'; document.getElementById('timeSaved').textContent=Math.round(w/200)+' min'; }
    function formatDate(d) { if(!d)return''; return new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }

    document.getElementById('searchInput').addEventListener('input', filterHistory);
    document.getElementById('styleFilter').addEventListener('change', filterHistory);
    function filterHistory() { const s = document.getElementById('searchInput').value.toLowerCase(), st = document.getElementById('styleFilter').value; renderHistory(historyData.filter(i => (!s||(i.filename&&i.filename.toLowerCase().includes(s))||(i.summary&&i.summary.toLowerCase().includes(s))) && (!st||i.style===st))); }

    function viewItem(id) { const i = historyData.find(h=>h.id===id); if(i) { document.getElementById('modalTitle').textContent=i.filename||'Résumé'; document.getElementById('modalContent').textContent=i.summary||''; document.getElementById('modalOverlay').classList.add('active'); } }
    function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
    async function copyItem(id) { const i = historyData.find(h=>h.id===id); if(i?.summary) { await navigator.clipboard.writeText(i.summary); alert('Copié !'); } }
    async function copyModalContent() { await navigator.clipboard.writeText(document.getElementById('modalContent').textContent); alert('Copié !'); }
    async function deleteItem(id) { if(!confirm('Supprimer ce résumé ?'))return; try { await fetch(`/api/history/${id}`,{method:'DELETE'}); loadHistory(); } catch(e){console.error(e);} }
    async function clearAllHistory() { if(!confirm('Supprimer tout l\'historique ?'))return; try { await fetch('/api/history/clear',{method:'POST'}); loadHistory(); } catch(e){console.error(e);} }

    document.getElementById('modalOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });

    checkAuth();
</script>
{% endblock %}
