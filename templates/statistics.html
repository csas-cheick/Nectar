{% extends "base.html" %}

{% block title %}Mes Statistiques - Nectar{% endblock %}

{% block nav_stats %}active{% endblock %}

{% block head %}
<style>
    .page-content { max-width: 1400px; margin: 0 auto; padding: 40px 32px; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
    .page-title h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
    .page-title h1 svg { width: 32px; height: 32px; color: var(--primary); }
    .page-title p { color: var(--text-dim); font-size: 1rem; }

    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 28px; text-align: center; position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
    .stat-card.purple::before { background: linear-gradient(90deg, #7c3aed, #a855f7); }
    .stat-card.green::before { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .stat-card.orange::before { background: linear-gradient(90deg, #f97316, #fb923c); }
    .stat-card.pink::before { background: linear-gradient(90deg, #ec4899, #f472b6); }
    .stat-card.cyan::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
    .stat-icon { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
    .stat-icon svg { width: 28px; height: 28px; }
    .stat-icon.purple { background: rgba(124, 58, 237, 0.15); color: #a855f7; }
    .stat-icon.green { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .stat-icon.orange { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .stat-icon.pink { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    .stat-icon.cyan { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 4px; }
    .stat-label { color: var(--text-dim); font-size: 0.9rem; }

    .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 40px; }
    .chart-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .chart-header h3 { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .chart-header h3 svg { width: 20px; height: 20px; color: var(--primary); }
    .chart-body { height: 280px; display: flex; align-items: flex-end; gap: 12px; padding: 20px 0; }
    .chart-bar { flex: 1; background: linear-gradient(180deg, var(--primary), rgba(124, 58, 237, 0.3)); border-radius: 8px 8px 0 0; position: relative; min-height: 20px; transition: all 0.3s; }
    .chart-bar:hover { filter: brightness(1.2); transform: scaleY(1.05); transform-origin: bottom; }
    .chart-bar-label { position: absolute; bottom: -28px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--text-dim); white-space: nowrap; }
    .chart-bar-value { position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; }

    .pie-chart { width: 200px; height: 200px; margin: 0 auto 24px; position: relative; }
    .pie-chart-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .pie-center { position: absolute; inset: 40px; background: var(--bg-secondary); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pie-center-value { font-size: 1.5rem; font-weight: 700; }
    .pie-center-label { font-size: 0.8rem; color: var(--text-dim); }
    .pie-legend { display: flex; flex-direction: column; gap: 12px; }
    .legend-item { display: flex; align-items: center; gap: 10px; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    .legend-label { flex: 1; font-size: 0.85rem; }
    .legend-value { font-weight: 600; font-size: 0.85rem; }

    .details-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    .detail-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
    .detail-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .detail-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .detail-icon svg { width: 22px; height: 22px; }
    .detail-icon.purple { background: rgba(124, 58, 237, 0.15); color: #a855f7; }
    .detail-icon.green { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .detail-icon.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .detail-header h3 { font-size: 1rem; font-weight: 600; }
    .detail-list { display: flex; flex-direction: column; gap: 16px; }
    .detail-item { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .detail-item:last-child { border-bottom: none; padding-bottom: 0; }
    .detail-item-label { color: var(--text-dim); font-size: 0.9rem; }
    .detail-item-value { font-weight: 600; }

    .login-required { text-align: center; padding: 120px 20px; }
    .login-required .empty-icon { width: 100px; height: 100px; background: rgba(124, 58, 237, 0.1); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
    .login-required .empty-icon svg { width: 50px; height: 50px; color: var(--text-dim); }
    .login-required h3 { font-size: 1.5rem; margin-bottom: 12px; }
    .login-required p { max-width: 400px; margin: 0 auto 32px; color: var(--text-dim); }

    @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .charts-row { grid-template-columns: 1fr; } .details-row { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .page-content { padding: 24px 16px; } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<!-- Si non connecté -->
<main class="page-content hidden" id="loginRequiredContent">
    <div class="login-required">
        <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        </div>
        <h3>Visualisez vos statistiques</h3>
        <p>Connectez-vous pour voir vos performances et analyses détaillées</p>
        <a href="/login" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            Se connecter
        </a>
    </div>
</main>

<!-- Si connecté -->
<main class="page-content" id="loggedInContent">
    <div class="page-header">
        <div class="page-title">
            <h1><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>Mes Statistiques</h1>
            <p>Analysez vos performances et suivez votre activité</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card purple"><div class="stat-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><div class="stat-value" id="totalDocs">0</div><div class="stat-label">Documents traités</div></div>
        <div class="stat-card green"><div class="stat-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20v-4"></path></svg></div><div class="stat-value" id="totalWords">0</div><div class="stat-label">Mots analysés</div></div>
        <div class="stat-card blue"><div class="stat-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div><div class="stat-value" id="avgCompression">0%</div><div class="stat-label">Compression moyenne</div></div>
        <div class="stat-card orange"><div class="stat-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div><div class="stat-value" id="timeSaved">0h</div><div class="stat-label">Temps économisé</div></div>
        <div class="stat-card pink"><div class="stat-icon pink"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg></div><div class="stat-value" id="summaryWords">0</div><div class="stat-label">Mots générés</div></div>
        <div class="stat-card cyan"><div class="stat-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg></div><div class="stat-value" id="avgLength">0</div><div class="stat-label">Longueur moy. (mots)</div></div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <div class="chart-header"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>Activité des 7 derniers jours</h3></div>
            <div class="chart-body" id="activityChart"></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>Répartition par style</h3></div>
            <div class="pie-chart"><svg class="pie-chart-svg" viewBox="0 0 100 100" id="pieChart"></svg><div class="pie-center"><div class="pie-center-value" id="pieTotal">0</div><div class="pie-center-label">Total</div></div></div>
            <div class="pie-legend" id="pieLegend"></div>
        </div>
    </div>

    <div class="details-row">
        <div class="detail-card">
            <div class="detail-header"><div class="detail-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg></div><h3>Documents</h3></div>
            <div class="detail-list">
                <div class="detail-item"><span class="detail-item-label">Cette semaine</span><span class="detail-item-value" id="docsThisWeek">0</span></div>
                <div class="detail-item"><span class="detail-item-label">Ce mois</span><span class="detail-item-value" id="docsThisMonth">0</span></div>
                <div class="detail-item"><span class="detail-item-label">Total</span><span class="detail-item-value" id="docsTotal">0</span></div>
            </div>
        </div>
        <div class="detail-card">
            <div class="detail-header"><div class="detail-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div><h3>Performance</h3></div>
            <div class="detail-list">
                <div class="detail-item"><span class="detail-item-label">Meilleure compression</span><span class="detail-item-value" id="bestCompression">0%</span></div>
                <div class="detail-item"><span class="detail-item-label">Plus long document</span><span class="detail-item-value" id="longestDoc">0 mots</span></div>
                <div class="detail-item"><span class="detail-item-label">Plus court résumé</span><span class="detail-item-value" id="shortestSummary">0 mots</span></div>
            </div>
        </div>
        <div class="detail-card">
            <div class="detail-header"><div class="detail-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div><h3>Temps</h3></div>
            <div class="detail-list">
                <div class="detail-item"><span class="detail-item-label">Temps moyen/résumé</span><span class="detail-item-value" id="avgTime">~3 sec</span></div>
                <div class="detail-item"><span class="detail-item-label">Temps lecture économisé</span><span class="detail-item-value" id="readingTimeSaved">0 min</span></div>
                <div class="detail-item"><span class="detail-item-label">Productivité</span><span class="detail-item-value" id="productivity">+0%</span></div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;

    async function checkAuth() {
        const user = await checkAuthAndUpdateHeader();
        if (user) {
            currentUser = user;
            document.getElementById('loggedInContent').classList.remove('hidden');
            loadStatistics();
        } else {
            document.getElementById('loggedInContent').classList.add('hidden');
            document.getElementById('loginRequiredContent').classList.remove('hidden');
        }
    }

    async function loadStatistics() {
        try {
            const res = await fetch('/api/history');
            const data = await res.json();
            if (data.success) { calculateStats(data.history || []); }
        } catch (e) { console.error(e); }
    }

    function calculateStats(history) {
        const total = history.length;
        const totalWords = history.reduce((s, i) => s + (i.original_words || 0), 0);
        const summaryWords = history.reduce((s, i) => s + (i.summary_words || 0), 0);
        const avgComp = total > 0 ? Math.round(history.reduce((s, i) => s + (i.compression_rate || 0), 0) / total) : 0;
        const timeSaved = Math.round(totalWords / 200);
        const avgLen = total > 0 ? Math.round(totalWords / total) : 0;

        document.getElementById('totalDocs').textContent = total;
        document.getElementById('totalWords').textContent = totalWords.toLocaleString();
        document.getElementById('summaryWords').textContent = summaryWords.toLocaleString();
        document.getElementById('avgCompression').textContent = avgComp + '%';
        document.getElementById('timeSaved').textContent = timeSaved >= 60 ? Math.round(timeSaved / 60) + 'h' : timeSaved + 'min';
        document.getElementById('avgLength').textContent = avgLen;

        // Weekly activity chart
        const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const today = new Date();
        const weekData = Array(7).fill(0);
        history.forEach(item => {
            const d = new Date(item.created_at);
            const diff = Math.floor((today - d) / (1000 * 60 * 60 * 24));
            if (diff >= 0 && diff < 7) weekData[6 - diff]++;
        });
        const maxVal = Math.max(...weekData, 1);
        document.getElementById('activityChart').innerHTML = weekData.map((v, i) => {
            const dayIndex = (today.getDay() - 6 + i + 7) % 7;
            return `<div class="chart-bar" style="height: ${(v / maxVal) * 100}%"><span class="chart-bar-value">${v}</span><span class="chart-bar-label">${days[dayIndex]}</span></div>`;
        }).join('');

        // Style pie chart
        const styles = { paragraph: 0, bullets: 0, academic: 0, simple: 0 };
        history.forEach(item => { if (styles[item.style] !== undefined) styles[item.style]++; });
        const colors = { paragraph: '#7c3aed', bullets: '#22c55e', academic: '#3b82f6', simple: '#f97316' };
        const labels = { paragraph: 'Paragraphe', bullets: 'Points clés', academic: 'Académique', simple: 'Simple' };
        let offset = 0;
        const pieHtml = Object.entries(styles).map(([k, v]) => {
            const pct = total > 0 ? (v / total) * 100 : 0;
            const dashArray = `${pct} ${100 - pct}`;
            const html = `<circle cx="50" cy="50" r="40" fill="none" stroke="${colors[k]}" stroke-width="20" stroke-dasharray="${dashArray}" stroke-dashoffset="${-offset}"/>`;
            offset += pct;
            return html;
        }).join('');
        document.getElementById('pieChart').innerHTML = pieHtml;
        document.getElementById('pieTotal').textContent = total;
        document.getElementById('pieLegend').innerHTML = Object.entries(styles).map(([k, v]) => `<div class="legend-item"><div class="legend-color" style="background:${colors[k]}"></div><span class="legend-label">${labels[k]}</span><span class="legend-value">${v}</span></div>`).join('');

        // Details
        const now = new Date();
        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
        document.getElementById('docsThisWeek').textContent = history.filter(i => new Date(i.created_at) >= weekAgo).length;
        document.getElementById('docsThisMonth').textContent = history.filter(i => new Date(i.created_at) >= monthAgo).length;
        document.getElementById('docsTotal').textContent = total;

        const compressions = history.map(i => i.compression_rate || 0);
        const originals = history.map(i => i.original_words || 0);
        const summaries = history.map(i => i.summary_words || 0);
        document.getElementById('bestCompression').textContent = (compressions.length ? Math.max(...compressions) : 0) + '%';
        document.getElementById('longestDoc').textContent = (originals.length ? Math.max(...originals) : 0) + ' mots';
        document.getElementById('shortestSummary').textContent = (summaries.length ? Math.min(...summaries.filter(s => s > 0)) || 0 : 0) + ' mots';

        document.getElementById('readingTimeSaved').textContent = timeSaved + ' min';
        document.getElementById('productivity').textContent = '+' + (avgComp > 0 ? Math.round(100 / (100 - avgComp) * 100 - 100) : 0) + '%';
    }

    checkAuth();
</script>
{% endblock %}
