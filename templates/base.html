<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Nectar{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/N_noire.svg" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/svg+xml" href="/N_blanc.svg" media="(prefers-color-scheme: dark)">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
<script>
    // Charger le thème sauvegardé immédiatement pour éviter le flash
    (function() {
        const savedTheme = localStorage.getItem('nectar-theme') || 'dark';
        document.body.classList.add(savedTheme === 'light' ? 'light-mode' : 'dark-mode');
    })();
</script>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/" class="brand-link">
                <div class="brand-logo"><img src="/N.svg" alt="Nectar" width="24" height="24"></div>
                <span>Nectar</span>
            </a>
        </div>
        
        <div class="nav-center">
            <a href="/" class="nav-tab {% block nav_resume %}{% endblock %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                Résumé
            </a>
            <a href="/" class="nav-tab {% block nav_analyser %}{% endblock %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                Analyser
            </a>
            <a href="/" class="nav-tab {% block nav_outils %}{% endblock %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Outils
            </a>
        </div>
        
        <div class="nav-end">
            <a href="/history" class="nav-link auth-link {% block nav_history %}{% endblock %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Historique
            </a>
            <a href="/statistics" class="nav-link auth-link {% block nav_stats %}{% endblock %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                Statistiques
            </a>
            <a href="/documentation" class="nav-link {% block nav_docs %}{% endblock %}">Documentation</a>
            
            <button class="btn-theme" id="themeToggle" title="Changer le thème" aria-label="Changer le thème">
                <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="icon-moon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            
            <div class="user-section" id="userSection">
                <a href="/login" class="btn btn-login" id="loginBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                    Connexion
                </a>
                <div class="user-menu hidden" id="userMenu">
                    <button class="user-btn" id="userBtn">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName">Utilisateur</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" class="dropdown-item logout" id="logoutBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                            Déconnexion
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- Script commun pour l'authentification -->
    <script>
        // Gestion du menu utilisateur
        document.getElementById('userBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('userDropdown')?.classList.toggle('show');
        });
        document.addEventListener('click', () => document.getElementById('userDropdown')?.classList.remove('show'));
        document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        });

        // Gestion du thème
        function initTheme() {
            const savedTheme = localStorage.getItem('nectar-theme') || 'dark';
            const isDark = savedTheme === 'dark';
            document.querySelector('.icon-sun')?.classList.toggle('hidden', !isDark);
            document.querySelector('.icon-moon')?.classList.toggle('hidden', isDark);
        }
        initTheme();
        
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            const isDark = document.body.classList.contains('dark-mode');
            document.body.classList.toggle('dark-mode', !isDark);
            document.body.classList.toggle('light-mode', isDark);
            localStorage.setItem('nectar-theme', isDark ? 'light' : 'dark');
            document.querySelector('.icon-sun')?.classList.toggle('hidden', isDark);
            document.querySelector('.icon-moon')?.classList.toggle('hidden', !isDark);
        });

        // Fonction globale pour vérifier l'auth et mettre à jour le header
        async function checkAuthAndUpdateHeader() {
            try {
                const res = await fetch('/auth/me');
                const data = await res.json();
                if (data.success && data.user) {
                    document.getElementById('loginBtn').classList.add('hidden');
                    document.getElementById('userMenu').classList.remove('hidden');
                    document.getElementById('userName').textContent = data.user.username;
                    document.getElementById('userAvatar').textContent = data.user.username.charAt(0).toUpperCase();
                    return data.user;
                }
            } catch (e) { console.error(e); }
            return null;
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
